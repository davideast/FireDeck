<html>
  <head>
    <title>Rendering in an iframe</title>
    <link href="/bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="/build/css/firedeck.css" rel="stylesheet" />
  </head>
  <body class="page realtime-1">

    <script src="/bower_components/jquery/dist/jquery.js"></script>
    <script src="/bower_components/firebase/firebase.js"></script>
    <script src="/bower_components/angular/angular.js"></script>
    <script src="/bower_components/angular-animate/angular-animate.js"></script>
    <script src="/bower_components/angular-sanitize/angular-sanitize.js"></script>
    <script src="/bower_components/angularfire/angularfire.exp.js"></script>
    <script>
      (function() {

          var codeRef = new Firebase('https://fire-deck.firebaseio.com/code/1/post');
          var providers = {};
          angular.module('Foo', [], function($controllerProvider, $compileProvider, $provide) {
              providers = {
                  $controllerProvider: $controllerProvider,
                  $compileProvider: $compileProvider,
                  $provide: $provide
              };
          });
          codeRef.on('value', function(snapshot) {
            eval(snapshot.val());
            angular.bootstrap($('body'), ['Foo']);
            // Store our _invokeQueue length before loading our controllers/directives/services
            // This is just so we don't re-register anything
            var queueLen = angular.module('Foo')._invokeQueue.length;
            // Load html file with content which uses above content
            $('<div ng-include="MessageCtrl.html"></div>').appendTo('body');
            $('<div id="ctrl" ng-controller="ChatCtrl">' +
                 '<h1 class="underline">Messages</h1>' +
                 '<input type="text" class="add-message" ng-model="newMessage" />' +
                 '<button ng-click="add()" class="btn button-primary">Add</button>' +
                 '<div class="message adjust-left" ng-repeat="message in messages">' +
                 '<span>{{ message }}</span>' +
                 '</div>' +
            '</div>').appendTo('body');
            // Register the controls/directives/services we just loaded
            var queue = angular.module('Foo')._invokeQueue;
            for(var i=queueLen;i<queue.length;i++) {
                var call = queue[i];
                // call is in the form [providerName, providerFunc, providerArguments]
                var provider = providers[call[0]];
                if(provider) {
                    // e.g. $controllerProvider.register("Ctrl", function() { ... })
                    provider[call[1]].apply(provider, call[2]);
                }
            }

            // compile the new element
            $('body').injector().invoke(function($compile, $rootScope) {
                $compile($('#ctrl'))($rootScope);
                $rootScope.$apply();
            });
          });

      }());
    </script>
  </body>
</html>
